# zona de memoria compartida (10MB, ~160k IPs)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

server {
    listen 80;
    server_name ryzenpc.mooo.com;

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name ryzenpc.mooo.com;

    ssl_certificate /etc/letsencrypt/live/ryzenpc.mooo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ryzenpc.mooo.com/privkey.pem;

    # üîí Headers de seguridad
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # üîê Internal Auth Verification for SSO
    # üîê SSO: Usuario Aprobado (B√°sico o Admin)
    location = /auth-verify {
        internal;
        proxy_pass http://backend:5000/api/auth/verify-sso;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        
        set $token_from_cookie "";
        if ($http_cookie ~* "auth_token=([^;]+)") {
            set $token_from_cookie $1;
        }
        proxy_set_header Authorization "Bearer $token_from_cookie";
    }

    # üîê SSO: Solo Administrador
    location = /auth-verify-admin {
        internal;
        proxy_pass http://backend:5000/api/auth/verify-admin;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        
        set $token_from_cookie "";
        if ($http_cookie ~* "auth_token=([^;]+)") {
            set $token_from_cookie $1;
        }
        proxy_set_header Authorization "Bearer $token_from_cookie";
    }

    error_page 401 403 = @error401;
    location @error401 {
        return 302 /?from=$request_uri#/login;
    }

    # üöÄ API Compra-Venta (Node.js)
    location /api/ {
    limit_req zone=api_limit burst=20 nodelay;
    proxy_pass http://backend:5000/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Content-Type $http_content_type;
    proxy_pass_request_body on;
    }

    # üöÄ API Finanzas (FastAPI)
    location /api/finanzas/ {
        auth_request /auth-verify;
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://finanzas-backend:8001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # üîå WebSocket proxy
    location /ws/ {
        proxy_pass http://backend:3000/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # üí∞ Assets est√°ticos de Finanzas
    location /finanzas/assets/ {
        proxy_pass http://finanzas-frontend:4200/assets/;  # ‚Üê Note: sin /finanzas/ aqu√≠
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache para assets
        expires 1y;
        add_header Cache-Control "public, immutable";
    }


    # üí∞ Aplicaci√≥n Angular - Finanzas
    location /finanzas/ {
        auth_request /auth-verify;
        proxy_pass http://finanzas-frontend:4200/finanzas/;  # ‚Üê A√ëADE /finanzas/ AL FINAL
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # IMPORTANTE: Reescribe las URLs para Angular
        proxy_redirect http://finanzas-frontend:4200/finanzas/ /finanzas/;
    }

    # üìÅ Servir script compartido desde directorio local
    location /shared/ {
        alias /usr/share/nginx/html/shared/;
        expires 1h;
        add_header Cache-Control "public";
    }

    # === TICKET SYSTEM (Spring Boot) ===
    location = /tickets {
        return 301 /tickets/;
    }

    location /tickets/ {
        auth_request /auth-verify-admin;
        proxy_pass http://tickets-app:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # üõí Frontend React - Compra-Venta (ruta principal)
    location / {
        proxy_pass http://frontend:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Original-URL $scheme://$host$request_uri;
    }

    # üêû Endpoint de depuraci√≥n
    location /debug {
    add_header Content-Type text/plain;
    return 200 "URL: $request_uri\nArgs: $args\nQuery: $query_string";
    
    }

    # === CONTACTOS (Laravel) ===
    location = /contactos {
        return 301 /contactos/;
    }

    location /contactos/ {
        auth_request /auth-verify;
        proxy_pass http://contact-manager-webserver:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Headers para Laravel
        proxy_set_header X-Forwarded-Prefix /contactos;
    }

    location /logo_light.png {
        alias /usr/share/nginx/html/assets/logo_light.png;
    }

    location /logo_dark.png {
        alias /usr/share/nginx/html/assets/logo_dark.png;
    }

    # === GEO DATA (FastAPI + React) ===
    location /geo/ {
        auth_request /auth-verify;
        alias /usr/share/nginx/html/geo/;
        index index.html index.htm;
        try_files $uri $uri/ /geo/index.html;
    }

    location /api/geo/ {
        auth_request /auth-verify;
        rewrite ^/api/geo/(.*)$ /$1 break;
        proxy_pass http://geo-backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

}